<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloud Cost Optimizer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .glass-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(226, 232, 240, 1);
        }
        .nav-link.active {
            background-color: rgba(16, 185, 129, 0.1);
            color: #10b981;
            border-right: 4px solid #10b981;
        }
        .page-content { display: none; }
        .page-content.active { display: block; }
        .app-row:hover .delete-btn { opacity: 1; }
        input:focus { outline: none; border-bottom: 2px solid #3b82f6 !important; }
        
        .switch {
            position: relative;
            display: inline-block;
            width: 34px;
            height: 20px;
        }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #cbd5e1;
            transition: .4s;
            border-radius: 20px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 14px; width: 14px;
            left: 3px; bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider { background-color: #3b82f6; }
        input:checked + .slider:before { transform: translateX(14px); }
        
        .type-switch input:checked + .slider { background-color: #10b981; } 
        .type-switch input:not(:checked) + .slider { background-color: #f43f5e; } 

        #status-toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 1000;
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
            transform: translateY(100px);
            opacity: 0;
        }
        #status-toast.show { transform: translateY(0); opacity: 1; }

        @media print {
            nav, .no-print { display: none !important; }
            .page-content { display: block !important; }
            body { background: white; }
            .glass-card { border: none; shadow: none; }
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen font-sans text-slate-900 flex flex-col md:flex-row">

    <!-- Status Toast -->
    <div id="status-toast" class="bg-slate-900 text-white px-6 py-3 rounded-2xl shadow-2xl flex items-center gap-3">
        <div id="toast-spinner" class="animate-spin w-4 h-4 border-2 border-emerald-400 border-t-transparent rounded-full hidden"></div>
        <span id="toast-message">Action successful</span>
    </div>

    <input type="file" id="json-import-input" accept=".json" class="hidden" onchange="handleFileImport(event)">

    <!-- Sidebar Navigation -->
    <nav class="w-full md:w-64 bg-slate-900 text-slate-300 md:min-h-screen flex flex-col shadow-2xl z-50">
        <div class="p-6 border-b border-slate-800">
            <h1 class="text-xl font-bold text-emerald-400">Savings Hub</h1>
            <p class="text-[10px] uppercase tracking-widest text-slate-500 mt-1">Cost Management</p>
        </div>
        <div class="flex-grow py-4 overflow-y-auto">
            <button onclick="showPage('annual')" id="nav-annual" class="nav-link w-full text-left px-6 py-4 flex items-center gap-3 hover:bg-slate-800 transition-colors active">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                Annual Spend
            </button>
            <button onclick="showPage('workspaces')" id="nav-workspaces" class="nav-link w-full text-left px-6 py-4 flex items-center gap-3 hover:bg-slate-800 transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                AWS WorkSpaces
            </button>
            <button onclick="showPage('decommissioned')" id="nav-decommissioned" class="nav-link w-full text-left px-6 py-4 flex items-center gap-3 hover:bg-slate-800 transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1-1v3M4 7h16" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                Decommissioned
            </button>
            <button onclick="showPage('nashtech')" id="nav-nashtech" class="nav-link w-full text-left px-6 py-4 flex items-center gap-3 hover:bg-slate-800 transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                Software Apps
            </button>
            <button onclick="showPage('summary')" id="nav-summary" class="nav-link w-full text-left px-6 py-4 flex items-center gap-3 hover:bg-slate-800 transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                Executive Summary
            </button>
            
            <div class="mt-8 px-4 space-y-4">
                <div>
                    <div class="flex justify-between items-center px-2 mb-2">
                        <p class="text-[9px] font-bold text-slate-500 uppercase tracking-widest">Cloud Backup</p>
                        <div class="flex items-center gap-2">
                            <span class="text-[8px] text-slate-500 uppercase font-bold">Auto</span>
                            <label class="switch scale-75">
                                <input type="checkbox" id="auto-sync-toggle" onchange="toggleAutoSync(event)">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                    <div class="flex flex-col gap-1">
                        <button onclick="saveToCloud()" id="btn-push" class="w-full flex items-center justify-center gap-2 py-2 px-4 rounded-xl border border-emerald-500/50 hover:bg-emerald-950/20 text-emerald-400 text-xs font-bold transition-all">
                            Push to Cloud
                        </button>
                        <button onclick="loadFromCloud()" class="w-full flex items-center justify-center gap-2 py-2 px-4 rounded-xl border border-slate-700 hover:bg-slate-800 text-xs text-slate-400 font-bold transition-all">
                            Pull from Cloud
                        </button>
                    </div>
                </div>

                <div>
                    <p class="text-[9px] font-bold text-slate-500 uppercase tracking-widest px-2 mb-2">Export & Import</p>
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="exportCSV()" class="flex items-center justify-center py-2 px-2 rounded-xl bg-slate-800 hover:bg-slate-700 text-[10px] font-bold transition-all">CSV</button>
                        <button onclick="exportJSON()" class="flex items-center justify-center py-2 px-2 rounded-xl bg-slate-800 hover:bg-slate-700 text-[10px] font-bold transition-all">JSON</button>
                    </div>
                    <button onclick="triggerJsonImport()" class="w-full mt-2 flex items-center justify-center gap-2 py-2 px-4 rounded-xl border border-slate-700 hover:bg-slate-800 text-xs text-slate-400 font-bold transition-all">
                        Import JSON
                    </button>
                    <button onclick="generateReport()" class="w-full mt-2 flex items-center justify-center gap-2 py-2 px-4 rounded-xl bg-emerald-600 hover:bg-emerald-700 text-white text-xs font-bold transition-all">
                        Generate Report
                    </button>
                </div>
            </div>
        </div>
        <div class="p-6 bg-slate-950/50">
            <p id="nav-cost-total" class="text-emerald-400 font-bold text-sm tracking-tight">£0 Active Spend</p>
        </div>
    </nav>

    <!-- Main Content Area -->
    <div class="flex-grow flex flex-col h-screen overflow-y-auto" id="main-content">
        
        <!-- Annual Spend Page -->
        <div id="page-annual" class="page-content active p-4 md:p-8">
            <header class="mb-8 flex justify-between items-end no-print">
                <div>
                    <h2 class="text-3xl font-bold text-slate-800">Annual Spend Tracking</h2>
                    <p class="text-slate-500 mt-2 text-sm">Log actual yearly AWS WorkSpaces invoice totals for historical tracking.</p>
                </div>
                <button onclick="addYearlyLog()" class="bg-slate-800 hover:bg-slate-950 text-white px-6 py-2 rounded-xl font-bold flex items-center gap-2 transition-all shadow-lg text-sm">
                    Log New Year
                </button>
            </header>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2">
                    <div class="glass-card rounded-3xl overflow-hidden shadow-sm">
                        <table class="w-full text-left border-collapse">
                            <thead class="bg-slate-50 border-b border-slate-100">
                                <tr>
                                    <th class="px-6 py-4 text-[10px] font-bold text-slate-400 uppercase tracking-wider">Year</th>
                                    <th class="px-6 py-4 text-[10px] font-bold text-slate-400 uppercase tracking-wider">Reference / Notes</th>
                                    <th class="px-6 py-4 text-[10px] font-bold text-slate-400 uppercase tracking-wider text-right">Actual Annual Spend</th>
                                    <th class="px-6 py-4 no-print"></th>
                                </tr>
                            </thead>
                            <tbody id="yearly-spend-body"></tbody>
                        </table>
                    </div>
                </div>
                <div class="space-y-6">
                    <div class="glass-card p-8 rounded-3xl bg-white border-l-4 border-emerald-500 shadow-lg">
                        <h4 class="text-xs font-bold text-slate-400 uppercase mb-4">Spend Comparison</h4>
                        <div class="space-y-4">
                            <div>
                                <p class="text-[10px] text-slate-400 uppercase font-bold">Projected (Fleet Tab)</p>
                                <p id="comparison-projected" class="text-2xl font-black text-slate-800">£0</p>
                            </div>
                            <div>
                                <p class="text-[10px] text-slate-400 uppercase font-bold">Latest Actual Year</p>
                                <p id="comparison-actual" class="text-2xl font-black text-blue-600">£0</p>
                            </div>
                            <div class="pt-4 border-t border-slate-100">
                                <p class="text-[10px] text-slate-400 uppercase font-bold">Variance</p>
                                <p id="comparison-variance" class="text-xl font-bold">£0</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- AWS WorkSpaces Page -->
        <div id="page-workspaces" class="page-content p-4 md:p-8">
            <header class="mb-8 flex justify-between items-end no-print">
                <div>
                    <h2 class="text-3xl font-bold text-slate-800">AWS WorkSpaces Fleets</h2>
                    <p class="text-slate-500 mt-2 text-sm">Review configurations and optimize billing models.</p>
                </div>
                <button onclick="addWsFleet()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-6 py-2 rounded-xl font-bold flex items-center gap-2 transition-all shadow-lg text-sm">
                    Add Fleet
                </button>
            </header>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                <div class="lg:col-span-2 space-y-6">
                    <div class="glass-card rounded-3xl overflow-hidden shadow-sm">
                        <div class="overflow-x-auto">
                            <table class="w-full text-left border-collapse">
                                <thead class="bg-slate-50 border-b border-slate-100">
                                    <tr>
                                        <th class="px-6 py-4 text-[10px] font-bold text-slate-400 uppercase tracking-wider">Fleet Name</th>
                                        <th class="px-6 py-4 text-[10px] font-bold text-slate-400 uppercase tracking-wider">Bundle</th>
                                        <th class="px-6 py-4 text-[10px] font-bold text-slate-400 uppercase tracking-wider text-center">Users</th>
                                        <th class="px-6 py-4 text-[10px] font-bold text-slate-400 uppercase tracking-wider text-center">Hours/Mo</th>
                                        <th class="px-6 py-4 text-[10px] font-bold text-slate-400 uppercase tracking-wider text-center">Always On</th>
                                        <th class="px-6 py-4 text-[10px] font-bold text-slate-400 uppercase tracking-wider text-right">Fleet Ann.</th>
                                        <th class="px-6 py-4 no-print"></th>
                                    </tr>
                                </thead>
                                <tbody id="ws-fleet-body"></tbody>
                            </table>
                        </div>
                    </div>

                    <div class="glass-card rounded-3xl p-6 shadow-sm no-print">
                        <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4">Pricing Reference (Monthly/Base+Hourly)</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-5 gap-4" id="bundle-reference-grid"></div>
                    </div>
                </div>

                <div class="glass-card rounded-3xl p-6 shadow-sm flex flex-col">
                    <h3 class="text-sm font-bold text-slate-800 mb-4">Model Efficiency</h3>
                    <div class="flex-grow relative" style="min-height: 200px;">
                        <canvas id="savingsChart"></canvas>
                    </div>
                    <div class="mt-4 p-4 bg-emerald-50 rounded-2xl border border-emerald-100">
                        <p id="chart-savings-callout" class="text-xl font-black text-emerald-700 text-center">£0</p>
                        <p class="text-[9px] text-emerald-500 text-center mt-1 uppercase">Potential Annual Savings</p>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white border border-slate-200 p-8 rounded-3xl shadow-sm">
                    <p class="text-slate-400 text-xs font-bold uppercase tracking-wider mb-2">WorkSpaces Annual Spend</p>
                    <p id="ws-total-annual" class="text-4xl font-black text-slate-800">£0</p>
                </div>
                <div class="bg-white border border-slate-200 p-8 rounded-3xl shadow-sm">
                    <p class="text-slate-400 text-xs font-bold uppercase tracking-wider mb-2">Total Users</p>
                    <p id="ws-total-users" class="text-4xl font-black text-slate-800">0</p>
                </div>
            </div>
        </div>

        <!-- Decommissioned Assets Page -->
        <div id="page-decommissioned" class="page-content p-4 md:p-8">
            <header class="mb-8 flex justify-between items-end no-print">
                <div>
                    <h2 class="text-3xl font-bold text-slate-800">Decommissioned Assets</h2>
                    <p class="text-slate-500 mt-2 text-sm">Realized savings from shutting down infrastructure.</p>
                </div>
                <button onclick="addDecomWs()" class="bg-slate-700 hover:bg-slate-800 text-white px-6 py-2 rounded-xl font-bold text-sm">
                    Add Asset
                </button>
            </header>
            <div class="glass-card rounded-3xl overflow-hidden shadow-sm">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-slate-50 border-b border-slate-100">
                        <tr>
                            <th class="px-6 py-4 text-xs font-bold text-slate-400 uppercase tracking-wider">Asset Description</th>
                            <th class="px-6 py-4 text-xs font-bold text-slate-400 uppercase tracking-wider">Bundle Type</th>
                            <th class="px-6 py-4 text-xs font-bold text-slate-400 uppercase tracking-wider text-center">Users</th>
                            <th class="px-6 py-4 text-xs font-bold text-slate-400 uppercase tracking-wider text-center">Always On</th>
                            <th class="px-6 py-4 text-xs font-bold text-slate-400 uppercase tracking-wider text-right">Monthly Saving</th>
                            <th class="px-6 py-4 text-xs font-bold text-slate-400 uppercase tracking-wider text-right">Annual Saving</th>
                            <th class="px-6 py-4 no-print"></th>
                        </tr>
                    </thead>
                    <tbody id="decom-ws-body"></tbody>
                </table>
            </div>
        </div>

        <!-- Software Tracker Page -->
        <div id="page-nashtech" class="page-content p-4 md:p-8">
            <header class="mb-8 flex justify-between items-end no-print">
                <div>
                    <h2 class="text-3xl font-bold text-slate-800">Software App Tracker</h2>
                    <p class="text-slate-500 mt-2 text-sm">Track external SaaS costs and optimization outcomes.</p>
                </div>
                <button onclick="addNewApp()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-xl font-bold text-sm">
                    Add App
                </button>
            </header>
            <div class="glass-card rounded-3xl overflow-hidden shadow-sm">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-slate-50 border-b border-slate-100">
                        <tr>
                            <th class="px-6 py-4 text-xs font-bold text-slate-400 uppercase tracking-wider">Application</th>
                            <th class="px-6 py-4 text-xs font-bold text-slate-400 uppercase tracking-wider text-center">Type</th>
                            <th class="px-6 py-4 text-xs font-bold text-slate-400 uppercase tracking-wider text-right">Monthly Unit Price</th>
                            <th class="px-6 py-4 text-xs font-bold text-slate-400 uppercase tracking-wider text-center">Users</th>
                            <th class="px-6 py-4 text-xs font-bold text-slate-400 uppercase tracking-wider text-right">Annual Total</th>
                            <th class="px-6 py-4 no-print"></th>
                        </tr>
                    </thead>
                    <tbody id="app-list-body"></tbody>
                </table>
            </div>
        </div>

        <!-- Summary Page -->
        <div id="page-summary" class="page-content p-4 md:p-8">
            <h2 class="text-3xl font-bold text-slate-800 mb-8">Executive Summary</h2>
            
            <!-- Financial Overview Section -->
            <div class="mb-10">
                <h3 class="text-xs font-bold text-slate-400 uppercase tracking-[0.2em] mb-4">Financial Overview</h3>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <div class="glass-card p-6 rounded-3xl shadow-sm border-l-4 border-slate-800">
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-2">Historical Actual Spend</p>
                        <p id="sum-actual-spend" class="text-3xl font-black text-slate-900">£0</p>
                    </div>
                    <div class="glass-card p-6 rounded-3xl shadow-sm border-l-4 border-rose-500">
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-2">Current Projected Total</p>
                        <p id="sum-liability" class="text-3xl font-black text-rose-600">£0</p>
                    </div>
                    <div class="glass-card p-6 rounded-3xl shadow-sm border-l-4 border-blue-500">
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-2">Pending Optimization</p>
                        <p id="sum-optimization" class="text-3xl font-black text-blue-600">£0</p>
                    </div>
                    <div class="glass-card p-6 rounded-3xl shadow-sm border-l-4 border-emerald-500">
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-2">Realized Annual Savings</p>
                        <p id="sum-savings" class="text-3xl font-black text-emerald-600">£0</p>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
                <div class="glass-card p-6 rounded-3xl bg-white col-span-3">
                    <h4 class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-4">Savings Origin Breakdown</h4>
                    <div id="savings-origin-list" class="grid grid-cols-1 md:grid-cols-3 gap-8">
                        <!-- Filled by JS -->
                    </div>
                </div>
            </div>

            <div class="bg-slate-900 p-10 rounded-[2.5rem] text-white shadow-2xl relative overflow-hidden">
                <div class="relative z-10">
                    <p class="text-emerald-400 text-xs font-bold uppercase tracking-[0.2em] mb-4">Total Net Business Value</p>
                    <div class="flex items-baseline gap-4">
                        <p id="sum-total-value" class="text-6xl font-black tracking-tighter text-white">£0</p>
                        <span class="text-emerald-500 font-bold text-sm">per annum</span>
                    </div>
                    <p class="text-slate-400 mt-6 text-sm max-w-xl">This figure represents the sum of realized infrastructure decommissioning, verified software cost reductions, and efficiency gains from workspace billing model optimization.</p>
                </div>
                <div class="absolute -right-20 -bottom-20 w-80 h-80 bg-emerald-500/10 rounded-full blur-3xl"></div>
            </div>
        </div>

        <!-- Report Template -->
        <div id="report-view" class="hidden fixed inset-0 bg-white z-[100] overflow-y-auto p-12">
            <div class="max-w-4xl mx-auto">
                <div class="flex justify-between items-start mb-12">
                    <div>
                        <h1 class="text-4xl font-black text-slate-900">Cost Optimization Report</h1>
                        <p id="report-date" class="text-slate-500 mt-2"></p>
                    </div>
                    <div class="text-right">
                        <p class="font-bold text-emerald-600">Savings Hub</p>
                        <p class="text-xs text-slate-400 uppercase">Automated Insight</p>
                    </div>
                </div>
                
                <div id="report-content"></div>

                <div class="mt-12 pt-8 border-t border-slate-100 flex justify-end gap-4 no-print">
                    <button onclick="closeReport()" class="px-6 py-2 rounded-xl border border-slate-200 font-bold">Close</button>
                    <button onclick="window.print()" class="px-6 py-2 rounded-xl bg-slate-900 text-white font-bold">Print / Save PDF</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, doc, setDoc, getDoc, collection } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        const hasFirebase = typeof __firebase_config !== 'undefined';
        const STORAGE_KEY = 'savings_hub_v3_data';
        const SETTINGS_KEY = 'savings_hub_v3_settings';
        
        let db, auth, user, appId;
        let wsFleets = [];
        let decomWs = [];
        let apps = [];
        let yearlyLogs = [];
        let savingsChart = null;
        let isAutoSyncEnabled = false;
        let autoSyncTimeout = null;

        const BUNDLES = {
            "value": { name: "Value", m: 26, hb: 8, hr: 0.22 },
            "standard": { name: "Standard", m: 33, hb: 11, hr: 0.30 },
            "perf": { name: "Performance", m: 45, hb: 13, hr: 0.42 },
            "power": { name: "Power", m: 65, hb: 13, hr: 0.62 },
            "powerpro": { name: "PowerPro", m: 110, hb: 16, hr: 1.15 }
        };

        const initApp = async () => {
            loadFromLocalStorage();
            loadSettings();
            renderBundleGrid();
            
            if (hasFirebase) {
                const firebaseConfig = JSON.parse(__firebase_config);
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                appId = typeof __app_id !== 'undefined' ? __app_id : 'cost-optimizer-default';
                onAuthStateChanged(auth, u => { 
                    user = u; 
                    if (user && isAutoSyncEnabled) triggerAutoSync();
                });
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth, __initial_auth_token);
                else await signInAnonymously(auth);
            }
            
            if (wsFleets.length === 0 && decomWs.length === 0 && apps.length === 0 && yearlyLogs.length === 0) {
                wsFleets = [{ id: 1, name: 'Sample Fleet', bundle: 'standard', users: 10, hours: 160, isAlwaysOn: true }];
                decomWs = [{ id: 2, name: 'Legacy Project VM', bundle: 'value', users: 1, isAlwaysOn: true }];
                yearlyLogs = [{ id: 3, year: 2024, amount: 4500, notes: 'Initial Baseline' }];
                refreshAll();
            }
        };

        function renderBundleGrid() {
            const grid = document.getElementById('bundle-reference-grid');
            if(!grid) return;
            grid.innerHTML = '';
            Object.keys(BUNDLES).forEach(key => {
                const b = BUNDLES[key];
                const card = document.createElement('div');
                card.className = 'p-3 bg-slate-50 border border-slate-100 rounded-2xl text-[11px]';
                card.innerHTML = `<p class="font-bold text-slate-800 mb-1">${b.name}</p><p class="text-emerald-600 font-bold">£${b.m} Mo</p><p class="text-slate-500">£${b.hb} + £${b.hr}/hr</p>`;
                grid.appendChild(card);
            });
        }

        function saveToLocalStorage() {
            const data = JSON.stringify({ wsFleets, decomWs, apps, yearlyLogs, timestamp: Date.now() });
            localStorage.setItem(STORAGE_KEY, data);
        }

        function loadFromLocalStorage() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    wsFleets = data.wsFleets || [];
                    decomWs = data.decomWs || [];
                    apps = data.apps || [];
                    yearlyLogs = data.yearlyLogs || [];
                    refreshAll();
                } catch (e) { console.error("Local load failed", e); }
            }
        }

        function loadSettings() {
            const saved = localStorage.getItem(SETTINGS_KEY);
            if (saved) {
                const settings = JSON.parse(saved);
                isAutoSyncEnabled = !!settings.autoSync;
                document.getElementById('auto-sync-toggle').checked = isAutoSyncEnabled;
                updateSyncUI();
            }
        }

        function toggleAutoSync(e) {
            isAutoSyncEnabled = e.target.checked;
            localStorage.setItem(SETTINGS_KEY, JSON.stringify({ autoSync: isAutoSyncEnabled }));
            updateSyncUI();
            if (isAutoSyncEnabled) triggerAutoSync();
        }

        function updateSyncUI() {
            const btn = document.getElementById('btn-push');
            if (isAutoSyncEnabled) {
                btn.classList.add('opacity-50', 'pointer-events-none');
                btn.innerHTML = 'Auto-Sync Active';
            } else {
                btn.classList.remove('opacity-50', 'pointer-events-none');
                btn.innerHTML = 'Push to Cloud';
            }
        }

        function triggerAutoSync() {
            if (!isAutoSyncEnabled || !user) return;
            if (autoSyncTimeout) clearTimeout(autoSyncTimeout);
            autoSyncTimeout = setTimeout(() => {
                saveToCloud(true);
            }, 2000); 
        }

        async function saveToCloud(isSilent = false) {
            if (!hasFirebase || !user) { 
                if (!isSilent) showToast("Sign-in required", true); 
                return; 
            }
            if (!isSilent) showToast("Syncing...", false, true);
            try {
                const configDoc = doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'config');
                await setDoc(configDoc, { wsFleets, decomWs, apps, yearlyLogs, updatedAt: new Date().toISOString() });
                if (!isSilent) showToast("Cloud Save Success");
            } catch (error) { 
                if (!isSilent) showToast("Cloud Save Error", true); 
            }
        }

        async function loadFromCloud() {
            if (!hasFirebase || !user) { showToast("Sign-in required", true); return; }
            showToast("Pulling...", false, true);
            try {
                const configDoc = doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'config');
                const snap = await getDoc(configDoc);
                if (snap.exists()) {
                    const data = snap.data();
                    wsFleets = data.wsFleets || [];
                    decomWs = data.decomWs || [];
                    apps = data.apps || [];
                    yearlyLogs = data.yearlyLogs || [];
                    saveToLocalStorage();
                    refreshAll();
                    showToast("Cloud Loaded");
                } else { showToast("No Cloud Data", true); }
            } catch (error) { showToast("Sync Failed", true); }
        }

        function refreshAll() {
            renderWsFleets(); 
            renderDecomWs(); 
            renderAppList();
            renderYearlyLogs();
            updateCalculationsAndUI();
            saveToLocalStorage();
            if (isAutoSyncEnabled) triggerAutoSync();
        }

        function updateCalculationsAndUI() {
            // WS Calcs
            let wsTotal = 0, wsOpt = 0, totalUsers = 0;
            wsFleets.forEach(f => {
                const b = BUNDLES[f.bundle];
                const autoStopMonthly = b.hb + (f.hours * b.hr);
                const currMonthly = f.isAlwaysOn ? b.m : autoStopMonthly;
                const bestMonthly = Math.min(autoStopMonthly, b.m);
                wsTotal += (currMonthly * f.users * 12);
                wsOpt += Math.max(0, (currMonthly - bestMonthly) * f.users * 12);
                totalUsers += f.users;
            });

            // App Calcs
            let appsLiability = 0, appsSavings = 0;
            apps.forEach(a => {
                const total = a.price * a.users * 12;
                if (a.isSaving) appsSavings += total;
                else appsLiability += total;
            });

            // Decom Calcs
            let decomTotal = 0;
            decomWs.forEach(d => {
                const b = BUNDLES[d.bundle];
                const monthly = d.isAlwaysOn ? b.m : (b.hb + (160 * b.hr));
                decomTotal += (monthly * d.users * 12);
            });

            // Actual Spend (latest log)
            const sortedLogs = [...yearlyLogs].sort((a,b) => b.year - a.year);
            const latestActual = sortedLogs[0]?.amount || 0;

            const overallLiability = wsTotal + appsLiability;
            const realizedSavings = decomTotal + appsSavings;
            const totalNetValue = realizedSavings + wsOpt;

            // Page Summary Updates
            document.getElementById('sum-actual-spend').innerText = `£${Math.round(latestActual).toLocaleString()}`;
            document.getElementById('sum-liability').innerText = `£${Math.round(overallLiability).toLocaleString()}`;
            document.getElementById('sum-optimization').innerText = `£${Math.round(wsOpt).toLocaleString()}`;
            document.getElementById('sum-savings').innerText = `£${Math.round(realizedSavings).toLocaleString()}`;
            document.getElementById('sum-total-value').innerText = `£${Math.round(totalNetValue).toLocaleString()}`;

            // Sidebar & General Updates
            document.getElementById('nav-cost-total').innerText = `£${Math.round(overallLiability).toLocaleString()} Active Spend`;

            // WS Tab Specific
            document.getElementById('ws-total-annual').innerText = `£${Math.round(wsTotal).toLocaleString()}`;
            document.getElementById('ws-total-users').innerText = totalUsers;
            const chartCallout = document.getElementById('chart-savings-callout');
            if (chartCallout) chartCallout.innerText = `£${Math.round(wsOpt).toLocaleString()}`;
            
            if (savingsChart) {
                savingsChart.data.datasets[0].data = [wsTotal, wsTotal - wsOpt];
                savingsChart.update();
            }

            renderOriginBreakdown(decomTotal, appsSavings, wsOpt);
        }

        function renderOriginBreakdown(decom, apps, ws) {
            const list = document.getElementById('savings-origin-list');
            if(!list) return;
            const total = decom + apps + ws;
            const origins = [
                { label: 'Decommissioned Assets', value: decom, color: 'emerald' },
                { label: 'Software App Tracker', value: apps, color: 'blue' },
                { label: 'AWS WorkSpaces Opt.', value: ws, color: 'amber' }
            ];
            list.innerHTML = origins.map(o => `
                <div class="p-4 bg-slate-50 rounded-2xl">
                    <div class="flex justify-between text-[11px] font-bold mb-2">
                        <span class="text-slate-500 uppercase">${o.label}</span>
                        <span class="text-${o.color}-600">£${Math.round(o.value).toLocaleString()}</span>
                    </div>
                    <div class="w-full bg-slate-200 h-2 rounded-full overflow-hidden">
                        <div class="bg-${o.color}-500 h-full" style="width: ${total > 0 ? (o.value / total * 100) : 0}%"></div>
                    </div>
                    <p class="text-[9px] text-slate-400 mt-2">${total > 0 ? Math.round(o.value/total*100) : 0}% of total optimization</p>
                </div>
            `).join('');
        }

        function showToast(msg, isError = false, showSpinner = false) {
            const toast = document.getElementById('status-toast');
            document.getElementById('toast-message').innerText = msg;
            toast.className = `fixed bottom-8 right-8 text-white px-6 py-3 rounded-2xl shadow-2xl flex items-center gap-3 transition-all duration-300 ${isError ? 'bg-rose-600' : 'bg-slate-900'} show`;
            document.getElementById('toast-spinner').classList.toggle('hidden', !showSpinner);
            if (!showSpinner) setTimeout(() => toast.classList.remove('show'), 3000);
        }

        function renderWsFleets() {
            const tbody = document.getElementById('ws-fleet-body');
            if(!tbody) return;
            tbody.innerHTML = '';
            wsFleets.forEach(f => {
                const b = BUNDLES[f.bundle];
                const currentMonthlyPerUser = f.isAlwaysOn ? b.m : (b.hb + (f.hours * b.hr));
                const row = document.createElement('tr');
                row.className = 'app-row border-b border-slate-50 hover:bg-slate-50/50 group text-sm';
                row.innerHTML = `
                    <td class="px-6 py-4"><input type="text" value="${f.name}" class="bg-transparent border-b border-transparent hover:border-slate-300 w-full" data-field="name"></td>
                    <td class="px-6 py-4">
                        <select class="bg-white border border-slate-200 rounded-lg p-1 text-xs w-full" data-field="bundle">
                            ${Object.keys(BUNDLES).map(k => `<option value="${k}" ${f.bundle === k ? 'selected' : ''}>${BUNDLES[k].name}</option>`).join('')}
                        </select>
                    </td>
                    <td class="px-6 py-4 text-center"><input type="number" value="${f.users}" class="bg-slate-50 border border-slate-200 rounded-lg p-1 text-center w-16" data-field="users"></td>
                    <td class="px-6 py-4 text-center"><input type="number" value="${f.hours}" class="bg-slate-50 border border-slate-200 rounded-lg p-1 text-center w-16" data-field="hours"></td>
                    <td class="px-6 py-4 text-center"><label class="switch"><input type="checkbox" ${f.isAlwaysOn ? 'checked' : ''} data-field="isAlwaysOn"><span class="slider"></span></label></td>
                    <td class="px-6 py-4 font-bold text-emerald-600 text-right">£${Math.round(currentMonthlyPerUser * f.users * 12).toLocaleString()}</td>
                    <td class="px-6 py-4 text-right no-print">
                        <button class="delete-btn opacity-0 group-hover:opacity-100 text-slate-300 hover:text-rose-500" onclick="deleteWsFleet(${f.id})">
                             <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1-1v3M4 7h16" stroke-width="2"></path></svg>
                        </button>
                    </td>
                `;
                row.querySelectorAll('input, select').forEach(el => {
                    el.addEventListener('change', e => {
                        const fleet = wsFleets.find(item => item.id === f.id);
                        if (fleet) {
                            const field = el.dataset.field;
                            fleet[field] = (field === 'isAlwaysOn') ? e.target.checked : (field === 'name' || field === 'bundle' ? e.target.value : parseFloat(e.target.value) || 0);
                            refreshAll();
                        }
                    });
                });
                tbody.appendChild(row);
            });
        }

        function renderYearlyLogs() {
            const tbody = document.getElementById('yearly-spend-body');
            if(!tbody) return;
            tbody.innerHTML = '';
            const sorted = [...yearlyLogs].sort((a,b) => b.year - a.year);
            sorted.forEach(log => {
                const row = document.createElement('tr');
                row.className = 'app-row border-b border-slate-50 hover:bg-slate-50/50 group text-sm';
                row.innerHTML = `
                    <td class="px-6 py-4"><input type="number" value="${log.year}" class="bg-transparent border-b border-transparent hover:border-slate-300 w-20 font-bold" data-field="year"></td>
                    <td class="px-6 py-4"><input type="text" value="${log.notes || ''}" placeholder="e.g. Audit ref" class="bg-transparent border-b border-transparent hover:border-slate-300 w-full text-slate-500" data-field="notes"></td>
                    <td class="px-6 py-4 text-right">£<input type="number" value="${log.amount}" class="bg-slate-50 border border-slate-200 rounded-lg p-1 text-right w-32 font-bold text-slate-800" data-field="amount"></td>
                    <td class="px-6 py-4 text-right no-print">
                        <button class="delete-btn opacity-0 group-hover:opacity-100 text-slate-300 hover:text-rose-500" onclick="deleteYearlyLog(${log.id})">
                             <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1-1v3M4 7h16" stroke-width="2"></path></svg>
                        </button>
                    </td>
                `;
                row.querySelectorAll('input').forEach(el => {
                    el.addEventListener('change', e => {
                        const item = yearlyLogs.find(i => i.id === log.id);
                        if (item) {
                            const field = el.dataset.field;
                            item[field] = field === 'notes' ? e.target.value : parseFloat(e.target.value) || 0;
                            refreshAll();
                        }
                    });
                });
                tbody.appendChild(row);
            });

            let fleetAnnual = 0;
            wsFleets.forEach(f => {
                const b = BUNDLES[f.bundle];
                fleetAnnual += (f.isAlwaysOn ? b.m : (b.hb + f.hours * b.hr)) * f.users * 12;
            });
            const latestLog = sorted[0]?.amount || 0;
            const variance = latestLog - fleetAnnual;
            const projEl = document.getElementById('comparison-projected');
            const actEl = document.getElementById('comparison-actual');
            const varEl = document.getElementById('comparison-variance');
            
            if(projEl) projEl.innerText = `£${Math.round(fleetAnnual).toLocaleString()}`;
            if(actEl) actEl.innerText = `£${Math.round(latestLog).toLocaleString()}`;
            if(varEl) {
                varEl.innerText = `${variance >= 0 ? '+' : '-'}£${Math.abs(Math.round(variance)).toLocaleString()}`;
                varEl.className = `text-xl font-bold ${variance > 0 ? 'text-rose-600' : 'text-emerald-600'}`;
            }
        }

        function renderDecomWs() {
            const tbody = document.getElementById('decom-ws-body');
            if(!tbody) return;
            tbody.innerHTML = '';
            decomWs.forEach(d => {
                const b = BUNDLES[d.bundle];
                const monthlySaving = d.isAlwaysOn ? b.m : (b.hb + (160 * b.hr));
                const row = document.createElement('tr');
                row.className = 'app-row border-b border-slate-50 hover:bg-slate-50/50 group text-sm';
                row.innerHTML = `
                    <td class="px-6 py-4"><input type="text" value="${d.name}" class="bg-transparent border-b border-transparent hover:border-slate-300 w-full" data-field="name"></td>
                    <td class="px-6 py-4">
                        <select class="bg-white border border-slate-200 rounded-lg p-1 text-xs w-full" data-field="bundle">
                            ${Object.keys(BUNDLES).map(k => `<option value="${k}" ${d.bundle === k ? 'selected' : ''}>${BUNDLES[k].name}</option>`).join('')}
                        </select>
                    </td>
                    <td class="px-6 py-4 text-center"><input type="number" value="${d.users}" class="bg-slate-50 border border-slate-200 rounded-lg p-1 text-center w-16" data-field="users"></td>
                    <td class="px-6 py-4 text-center"><label class="switch"><input type="checkbox" ${d.isAlwaysOn ? 'checked' : ''} data-field="isAlwaysOn"><span class="slider"></span></label></td>
                    <td class="px-6 py-4 text-right text-slate-500">£${Math.round(monthlySaving * d.users).toLocaleString()}</td>
                    <td class="px-6 py-4 text-right font-bold text-emerald-600">£${Math.round(monthlySaving * d.users * 12).toLocaleString()}</td>
                    <td class="px-6 py-4 text-right no-print">
                        <button class="delete-btn opacity-0 group-hover:opacity-100 text-slate-300 hover:text-rose-500" onclick="deleteDecom(${d.id})">
                             <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1-1v3M4 7h16" stroke-width="2"></path></svg>
                        </button>
                    </td>
                `;
                row.querySelectorAll('input, select').forEach(el => {
                    el.addEventListener('change', e => {
                        const asset = decomWs.find(item => item.id === d.id);
                        if (asset) {
                            const field = el.dataset.field;
                            asset[field] = (field === 'isAlwaysOn') ? e.target.checked : (field === 'name' || field === 'bundle' ? e.target.value : parseFloat(e.target.value) || 0);
                            refreshAll();
                        }
                    });
                });
                tbody.appendChild(row);
            });
        }

        function renderAppList() {
            const tbody = document.getElementById('app-list-body');
            if(!tbody) return;
            tbody.innerHTML = '';
            apps.forEach(a => {
                const row = document.createElement('tr');
                row.className = 'app-row border-b border-slate-50 hover:bg-slate-50/50 group text-sm';
                row.innerHTML = `
                    <td class="px-6 py-4 font-medium"><input type="text" value="${a.name}" class="bg-transparent border-b border-transparent hover:border-slate-300 w-full" data-field="name"></td>
                    <td class="px-6 py-4 text-center">
                        <div class="flex items-center justify-center gap-2">
                            <span class="text-[10px] font-bold text-rose-500">Liab.</span>
                            <label class="switch type-switch">
                                <input type="checkbox" ${a.isSaving ? 'checked' : ''} data-field="isSaving">
                                <span class="slider"></span>
                            </label>
                            <span class="text-[10px] font-bold text-emerald-500">Save</span>
                        </div>
                    </td>
                    <td class="px-6 py-4 text-right">£<input type="number" value="${a.price}" class="bg-transparent text-right w-20 border-b border-transparent hover:border-slate-300" data-field="price"></td>
                    <td class="px-6 py-4 text-center"><input type="number" value="${a.users}" class="bg-slate-50 border border-slate-200 rounded-lg p-1 text-center w-16" data-field="users"></td>
                    <td class="px-6 py-4 text-right font-bold ${a.isSaving ? 'text-emerald-600' : 'text-rose-600'}">
                        ${a.isSaving ? '+' : '-'}£${Math.round(a.price * a.users * 12).toLocaleString()}
                    </td>
                    <td class="px-6 py-4 text-right no-print">
                        <button class="delete-btn opacity-0 group-hover:opacity-100 text-slate-300 hover:text-rose-500" onclick="deleteApp(${a.id})">
                             <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1-1v3M4 7h16" stroke-width="2"></path></svg>
                        </button>
                    </td>
                `;
                row.querySelectorAll('input').forEach(el => {
                    el.addEventListener('change', e => {
                        const appItem = apps.find(item => item.id === a.id);
                        if (appItem) {
                            const field = el.dataset.field;
                            appItem[field] = field === 'isSaving' ? e.target.checked : (field === 'name' ? e.target.value : parseFloat(e.target.value) || 0);
                            refreshAll();
                        }
                    });
                });
                tbody.appendChild(row);
            });
        }

        window.exportCSV = () => {
            let csv = "Type,Name,Users,Annual Amount\n";
            wsFleets.forEach(f => {
                const b = BUNDLES[f.bundle];
                const cost = (f.isAlwaysOn ? b.m : (b.hb + f.hours * b.hr)) * f.users * 12;
                csv += `WorkSpace Fleet,${f.name},${f.users},-${cost}\n`;
            });
            apps.forEach(a => csv += `Software App,${a.name},${a.users},${a.isSaving ? '+' : '-'}${a.price * a.users * 12}\n`);
            decomWs.forEach(d => {
                const b = BUNDLES[d.bundle];
                const monthly = d.isAlwaysOn ? b.m : (b.hb + (160 * b.hr));
                csv += `Decommissioned,${d.name},${d.users},+${monthly * d.users * 12}\n`;
            });
            downloadFile(csv, 'savings_report.csv', 'text/csv');
        };

        window.exportJSON = () => {
            const data = { wsFleets, decomWs, apps, yearlyLogs, summary: { date: new Date().toISOString() } };
            downloadFile(JSON.stringify(data, null, 2), 'savings_data.json', 'application/json');
        };

        window.triggerJsonImport = () => document.getElementById('json-import-input').click();
        window.handleFileImport = (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    wsFleets = data.wsFleets || [];
                    decomWs = data.decomWs || [];
                    apps = data.apps || [];
                    yearlyLogs = data.yearlyLogs || [];
                    refreshAll();
                    showToast("Data imported successfully");
                } catch (err) { showToast("Invalid JSON", true); }
            };
            reader.readAsText(file);
        };

        function downloadFile(content, fileName, mimeType) {
            const a = document.createElement('a');
            const blob = new Blob([content], { type: mimeType });
            a.href = URL.createObjectURL(blob);
            a.download = fileName;
            a.click();
        }

        window.generateReport = () => {
            const date = new Date().toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' });
            document.getElementById('report-date').innerText = date;
            let wsTotal = 0, wsOpt = 0;
            wsFleets.forEach(f => {
                const b = BUNDLES[f.bundle];
                const curr = (f.isAlwaysOn ? b.m : (b.hb + f.hours * b.hr)) * f.users * 12;
                wsTotal += curr;
                wsOpt += Math.max(0, curr - (Math.min(b.m, (b.hb + f.hours * b.hr)) * f.users * 12));
            });
            let appLiab = 0, appSave = 0;
            apps.forEach(a => { if(a.isSaving) appSave += a.price * a.users * 12; else appLiab += a.price * a.users * 12; });
            let decomVal = 0; 
            decomWs.forEach(d => {
                const b = BUNDLES[d.bundle];
                const monthly = d.isAlwaysOn ? b.m : (b.hb + (160 * b.hr));
                decomVal += monthly * d.users * 12;
            });
            let html = `
                <div class="grid grid-cols-2 gap-8 mb-12">
                    <div class="p-6 bg-slate-50 rounded-2xl">
                        <h4 class="text-xs font-bold text-slate-400 uppercase mb-2">Annual Overall Total</h4>
                        <p class="text-3xl font-black">£${Math.round(wsTotal + appLiab).toLocaleString()}</p>
                    </div>
                    <div class="p-6 bg-emerald-50 rounded-2xl">
                        <h4 class="text-xs font-bold text-emerald-600 uppercase mb-2">Realized Value (Saved)</h4>
                        <p class="text-3xl font-black text-emerald-700">£${Math.round(decomVal + appSave).toLocaleString()}</p>
                    </div>
                </div>
                <h3 class="text-xl font-bold mb-4 border-b pb-2">Optimization Sources</h3>
                <div class="space-y-4 mb-12">
                   <div class="flex justify-between"><span>Decommissioned Assets</span><strong>£${Math.round(decomVal).toLocaleString()}</strong></div>
                   <div class="flex justify-between"><span>Software App Tracker</span><strong>£${Math.round(appSave).toLocaleString()}</strong></div>
                   <div class="flex justify-between"><span>AWS WorkSpaces Optimization</span><strong>£${Math.round(wsOpt).toLocaleString()}</strong></div>
                </div>
            `;
            document.getElementById('report-content').innerHTML = html;
            document.getElementById('report-view').classList.remove('hidden');
        };

        window.closeReport = () => document.getElementById('report-view').classList.add('hidden');
        window.showPage = id => {
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            const navEl = document.getElementById('nav-' + id);
            if (navEl) navEl.classList.add('active');
            
            document.querySelectorAll('.page-content').forEach(p => p.classList.remove('active'));
            const pageEl = document.getElementById('page-' + id);
            if (pageEl) pageEl.classList.add('active');
        };

        window.addWsFleet = () => { wsFleets.push({ id: Date.now(), name: 'New Fleet', bundle: 'standard', users: 5, hours: 40, isAlwaysOn: false }); refreshAll(); };
        window.deleteWsFleet = id => { wsFleets = wsFleets.filter(f => f.id !== id); refreshAll(); };
        window.addDecomWs = () => { decomWs.push({ id: Date.now(), name: 'Retired Asset', bundle: 'standard', users: 1, isAlwaysOn: true }); refreshAll(); };
        window.deleteDecom = id => { decomWs = decomWs.filter(d => d.id !== id); refreshAll(); };
        window.addNewApp = () => { apps.push({ id: Date.now(), name: 'New App', price: 0, users: 1, isSaving: false }); refreshAll(); };
        window.deleteApp = id => { apps = apps.filter(a => a.id !== id); refreshAll(); };
        window.addYearlyLog = () => { yearlyLogs.push({ id: Date.now(), year: new Date().getFullYear(), amount: 0, notes: '' }); refreshAll(); };
        window.deleteYearlyLog = id => { yearlyLogs = yearlyLogs.filter(l => l.id !== id); refreshAll(); };
        window.toggleAutoSync = toggleAutoSync;
        window.saveToCloud = saveToCloud;
        window.loadFromCloud = loadFromCloud;

        window.addEventListener('DOMContentLoaded', () => {
            const chartCanvas = document.getElementById('savingsChart');
            if (chartCanvas) {
                const ctx = chartCanvas.getContext('2d');
                savingsChart = new Chart(ctx, {
                    type: 'bar',
                    data: { labels: ['Current', 'Optimized'], datasets: [{ data: [0, 0], backgroundColor: ['#1e293b', '#10b981'], borderRadius: 8 }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, display: false }, x: { grid: { display: false } } } }
                });
            }
            initApp();
        });
    </script>
</body>
</html>