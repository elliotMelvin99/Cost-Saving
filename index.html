<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloud Cost Optimizer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .glass-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(226, 232, 240, 1);
        }
        .nav-link.active {
            background-color: rgba(16, 185, 129, 0.1);
            color: #10b981;
            border-right: 4px solid #10b981;
        }
        .page-content { display: none; }
        .page-content.active { display: block; }
        .app-row:hover .delete-btn { opacity: 1; }
        
        .switch {
            position: relative;
            display: inline-block;
            width: 34px;
            height: 20px;
        }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #cbd5e1;
            transition: .4s;
            border-radius: 20px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 14px; width: 14px;
            left: 3px; bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider { background-color: #3b82f6; }
        input:checked + .slider:before { transform: translateX(14px); }
        
        #status-toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 1000;
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
            transform: translateY(100px);
            opacity: 0;
        }
        #status-toast.show { transform: translateY(0); opacity: 1; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen font-sans text-slate-900 flex flex-col md:flex-row">

    <!-- Status Toast -->
    <div id="status-toast" class="bg-slate-900 text-white px-6 py-3 rounded-2xl shadow-2xl flex items-center gap-3">
        <span id="toast-message">Action successful</span>
    </div>

    <!-- Sidebar Navigation -->
    <nav class="w-full md:w-64 bg-slate-900 text-slate-300 md:min-h-screen flex flex-col shadow-2xl z-50 no-print">
        <div class="p-6 border-b border-slate-800">
            <h1 class="text-xl font-bold text-emerald-400">Savings Hub</h1>
            <p class="text-[10px] uppercase tracking-widest text-slate-500 mt-1">Cost Management</p>
        </div>
        <div class="flex-grow py-4 overflow-y-auto">
            <button onclick="showPage('annual')" id="nav-annual" class="nav-link w-full text-left px-6 py-4 flex items-center gap-3 hover:bg-slate-800 transition-colors active">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                Annual Spend
            </button>
            <button onclick="showPage('workspaces')" id="nav-workspaces" class="nav-link w-full text-left px-6 py-4 flex items-center gap-3 hover:bg-slate-800 transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                AWS WorkSpaces
            </button>
            <button onclick="showPage('decommissioned')" id="nav-decommissioned" class="nav-link w-full text-left px-6 py-4 flex items-center gap-3 hover:bg-slate-800 transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1-1v3M4 7h16" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                Decommissioned
            </button>
            <button onclick="showPage('nashtech')" id="nav-nashtech" class="nav-link w-full text-left px-6 py-4 flex items-center gap-3 hover:bg-slate-800 transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                Software Apps
            </button>
            <button onclick="showPage('summary')" id="nav-summary" class="nav-link w-full text-left px-6 py-4 flex items-center gap-3 hover:bg-slate-800 transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                Executive Summary
            </button>
            
            <div class="mt-8 px-4 space-y-4">
                <div class="no-print">
                    <div class="flex justify-between items-center px-2 mb-2">
                        <p class="text-[9px] font-bold text-slate-500 uppercase tracking-widest">Team Sync</p>
                        <div class="flex items-center gap-2">
                            <span class="text-[8px] text-slate-500 uppercase font-bold">Auto</span>
                            <label class="switch scale-75">
                                <input type="checkbox" id="auto-sync-toggle">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                    <div class="flex flex-col gap-1">
                        <button id="btn-push" class="w-full flex items-center justify-center gap-2 py-2 px-4 rounded-xl border border-emerald-500/50 hover:bg-emerald-950/20 text-emerald-400 text-xs font-bold transition-all">
                            Push to Team
                        </button>
                        <button id="btn-refresh" class="w-full flex items-center justify-center gap-2 py-2 px-4 rounded-xl border border-slate-700 hover:bg-slate-800 text-xs text-slate-400 font-bold transition-all">
                            Refresh Data
                        </button>
                        <button onclick="exportToText()" class="w-full flex items-center justify-center gap-2 py-3 px-4 rounded-xl bg-emerald-600 hover:bg-emerald-700 text-xs text-white font-bold transition-all mt-2 shadow-lg shadow-emerald-900/20">
                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                            Export Data (.txt)
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div class="p-6 bg-slate-950/50 no-print">
            <p id="nav-cost-total" class="text-emerald-400 font-bold text-sm tracking-tight">£0 Active Spend</p>
            <p id="auth-status" class="text-[9px] text-slate-500 mt-1 uppercase font-bold">Checking Connection...</p>
        </div>
    </nav>

    <!-- Main Content Area -->
    <div class="flex-grow flex flex-col h-screen overflow-y-auto" id="main-content">
        <!-- Annual Spend Page -->
        <div id="page-annual" class="page-content active p-4 md:p-8">
            <header class="mb-8 flex justify-between items-end">
                <div>
                    <h2 class="text-3xl font-bold text-slate-800">Annual Spend Tracking</h2>
                    <p class="text-slate-500 mt-2 text-sm">Log actual yearly AWS WorkSpaces invoice totals.</p>
                </div>
                <button onclick="addYearlyLog()" class="bg-slate-800 hover:bg-slate-950 text-white px-6 py-2 rounded-xl font-bold text-sm shadow-lg">
                    Log New Year
                </button>
            </header>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2">
                    <div class="glass-card rounded-3xl overflow-hidden shadow-sm">
                        <table class="w-full text-left border-collapse">
                            <thead class="bg-slate-50 border-b border-slate-100">
                                <tr>
                                    <th class="px-6 py-4 text-[10px] font-bold text-slate-400 uppercase tracking-wider">Year</th>
                                    <th class="px-6 py-4 text-[10px] font-bold text-slate-400 uppercase tracking-wider">Reference / Notes</th>
                                    <th class="px-6 py-4 text-[10px] font-bold text-slate-400 uppercase tracking-wider text-right">Actual Annual Spend</th>
                                    <th class="px-6 py-4 no-print"></th>
                                </tr>
                            </thead>
                            <tbody id="yearly-spend-body"></tbody>
                        </table>
                    </div>
                </div>
                <div class="space-y-6">
                    <div class="glass-card p-8 rounded-3xl bg-white border-l-4 border-emerald-500 shadow-lg">
                        <h4 class="text-xs font-bold text-slate-400 uppercase mb-4">Spend Comparison</h4>
                        <div class="space-y-4">
                            <div>
                                <p class="text-[10px] text-slate-400 uppercase font-bold">Projected (Fleet Tab)</p>
                                <p id="comparison-projected" class="text-2xl font-black text-slate-800">£0</p>
                            </div>
                            <div>
                                <p class="text-[10px] text-slate-400 uppercase font-bold">Latest Actual Year</p>
                                <p id="comparison-actual" class="text-2xl font-black text-blue-600">£0</p>
                            </div>
                            <div class="pt-4 border-t border-slate-100">
                                <p class="text-[10px] text-slate-400 uppercase font-bold">Variance</p>
                                <p id="comparison-variance" class="text-xl font-bold">£0</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- AWS WorkSpaces Page -->
        <div id="page-workspaces" class="page-content p-4 md:p-8">
            <header class="mb-8 flex justify-between items-end">
                <div>
                    <h2 class="text-3xl font-bold text-slate-800">AWS WorkSpaces Fleets</h2>
                    <p class="text-slate-500 mt-1 text-sm">Model your active infrastructure and optimization settings.</p>
                </div>
                <button onclick="addWsFleet()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-6 py-2 rounded-xl font-bold text-sm shadow-lg">Add Fleet</button>
            </header>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                <div class="glass-card p-6 rounded-3xl shadow-sm border-l-4 border-slate-900">
                    <p class="text-[10px] font-bold text-slate-400 uppercase mb-1">Total Fleet Users</p>
                    <p id="ws-total-users" class="text-3xl font-black text-slate-900">0</p>
                </div>
                <div class="glass-card p-6 rounded-3xl shadow-sm border-l-4 border-emerald-500">
                    <p class="text-[10px] font-bold text-slate-400 uppercase mb-1">Fleet Annual Cost</p>
                    <p id="ws-total-annual" class="text-3xl font-black text-emerald-600">£0</p>
                </div>
                <div class="glass-card p-6 rounded-3xl shadow-sm border-l-4 border-blue-500 hidden lg:block">
                    <p class="text-[10px] font-bold text-slate-400 uppercase mb-1">Optimization Potential</p>
                    <p id="ws-total-opt" class="text-3xl font-black text-blue-600">£0</p>
                </div>
            </div>

            <div class="grid grid-cols-1 xl:grid-cols-3 gap-8">
                <div class="xl:col-span-2 space-y-8">
                    <div class="glass-card rounded-3xl overflow-hidden shadow-sm">
                        <table class="w-full text-left border-collapse">
                            <thead class="bg-slate-50 border-b border-slate-100">
                                <tr>
                                    <th class="px-6 py-4 text-xs font-bold text-slate-400 uppercase tracking-wider">Fleet Name</th>
                                    <th class="px-6 py-4 text-xs font-bold text-slate-400 uppercase tracking-wider">Bundle</th>
                                    <th class="px-6 py-4 text-xs font-bold text-slate-400 uppercase tracking-wider text-center">Users</th>
                                    <th class="px-6 py-4 text-xs font-bold text-slate-400 uppercase tracking-wider text-center">Hours/Mo</th>
                                    <th class="px-6 py-4 text-xs font-bold text-slate-400 uppercase tracking-wider text-center">Always On</th>
                                    <th class="px-6 py-4 text-xs font-bold text-slate-400 uppercase tracking-wider text-right">Fleet Ann.</th>
                                    <th class="px-6 py-4 no-print"></th>
                                </tr>
                            </thead>
                            <tbody id="ws-fleet-body"></tbody>
                        </table>
                    </div>
                </div>
                <div class="space-y-6">
                    <div class="glass-card p-8 rounded-3xl shadow-sm h-fit">
                        <h4 class="text-xs font-bold text-slate-400 uppercase mb-6 text-center">Cost Model Efficiency</h4>
                        <div class="relative h-64"><canvas id="efficiency-chart"></canvas></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Decommissioned Assets Page -->
        <div id="page-decommissioned" class="page-content p-4 md:p-8">
            <header class="mb-8 flex justify-between items-end">
                <div>
                    <h2 class="text-3xl font-bold text-slate-800">Decommissioned Assets</h2>
                    <p class="text-slate-500 mt-1 text-sm">Track savings realized from retired infrastructure.</p>
                </div>
                <button onclick="addDecomWs()" class="bg-slate-700 hover:bg-slate-800 text-white px-6 py-2 rounded-xl font-bold text-sm shadow-lg">Add Retired Asset</button>
            </header>
            <div class="glass-card rounded-3xl overflow-hidden shadow-sm">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-slate-50 border-b border-slate-100">
                        <tr>
                            <th class="px-6 py-4 text-xs font-bold text-slate-400 uppercase tracking-wider">Asset / Project</th>
                            <th class="px-6 py-4 text-xs font-bold text-slate-400 uppercase tracking-wider">Bundle</th>
                            <th class="px-6 py-4 text-xs font-bold text-slate-400 uppercase tracking-wider text-center">Users</th>
                            <th class="px-6 py-4 text-xs font-bold text-slate-400 uppercase tracking-wider text-center">Hours/Mo</th>
                            <th class="px-6 py-4 text-xs font-bold text-slate-400 uppercase tracking-wider text-center">Always On</th>
                            <th class="px-6 py-4 text-xs font-bold text-slate-400 uppercase tracking-wider text-right">Ann. Saving</th>
                            <th class="px-6 py-4 no-print"></th>
                        </tr>
                    </thead>
                    <tbody id="decom-ws-body"></tbody>
                </table>
            </div>
        </div>

        <!-- Software Tracker Page -->
        <div id="page-nashtech" class="page-content p-4 md:p-8">
            <header class="mb-8 flex justify-between items-end">
                <h2 class="text-3xl font-bold text-slate-800">Software App Tracker</h2>
                <button onclick="addNewApp()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-xl font-bold text-sm">Add App</button>
            </header>
            <div class="glass-card rounded-3xl overflow-hidden shadow-sm">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-slate-50 border-b border-slate-100">
                        <tr>
                            <th class="px-6 py-4 text-xs font-bold text-slate-400 uppercase tracking-wider">Application</th>
                            <th class="px-6 py-4 text-xs font-bold text-slate-400 uppercase tracking-wider text-center">Type</th>
                            <th class="px-6 py-4 text-xs font-bold text-slate-400 uppercase tracking-wider text-right">Annual Total</th>
                            <th class="px-6 py-4 no-print"></th>
                        </tr>
                    </thead>
                    <tbody id="app-list-body"></tbody>
                </table>
            </div>
        </div>

        <!-- Summary Page -->
        <div id="page-summary" class="page-content p-4 md:p-8">
            <header class="mb-10 flex justify-between items-start">
                <div>
                    <h2 class="text-4xl font-black text-slate-900 tracking-tight">Executive Summary</h2>
                    <p class="text-slate-500 mt-2 font-medium">Consolidated Financial Overview & Business Value Tracking</p>
                </div>
            </header>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                <div class="glass-card p-10 rounded-[2.5rem] border-l-8 border-slate-800 shadow-xl relative overflow-hidden">
                    <p class="text-slate-400 text-xs font-bold uppercase tracking-widest mb-2">Historical Actual Spend</p>
                    <p id="sum-actual-spend" class="text-5xl font-black text-slate-900">£0</p>
                </div>
                <div class="glass-card p-10 rounded-[2.5rem] border-l-8 border-rose-500 shadow-xl bg-rose-50/20">
                    <p class="text-rose-500 text-xs font-bold uppercase tracking-widest mb-2">Projected Annual Liability</p>
                    <p id="sum-liability" class="text-5xl font-black text-slate-900">£0</p>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-12">
                <div class="glass-card p-6 rounded-3xl shadow-md border-t-4 border-slate-400">
                    <p class="text-[10px] text-slate-400 font-bold uppercase mb-2">WorkSpace Fleets</p>
                    <p id="sum-breakdown-ws" class="text-2xl font-black text-slate-800">£0</p>
                    <p id="sum-breakdown-ws-opt" class="text-[11px] text-emerald-600 font-bold mt-1">£0 Optimization Opportunity</p>
                </div>
                <div class="glass-card p-6 rounded-3xl shadow-md border-t-4 border-blue-400">
                    <p class="text-[10px] text-slate-400 font-bold uppercase mb-2">Decommissioned Assets</p>
                    <p id="sum-breakdown-decom" class="text-2xl font-black text-slate-800">£0</p>
                </div>
                <div class="glass-card p-6 rounded-3xl shadow-md border-t-4 border-indigo-400">
                    <p class="text-[10px] text-slate-400 font-bold uppercase mb-2">Software (Net Impact)</p>
                    <p id="sum-breakdown-sw" class="text-2xl font-black text-slate-800">£0</p>
                </div>
            </div>

            <div class="bg-slate-900 p-12 rounded-[3rem] text-white shadow-2xl relative overflow-hidden">
                <p class="text-emerald-400 text-sm font-black uppercase tracking-[0.3em] mb-4">Total Realized Value + Savings</p>
                <div class="flex items-baseline gap-4">
                    <p id="sum-total-value" class="text-7xl font-black text-white">£0</p>
                    <span class="text-emerald-500 font-bold text-lg">per annum</span>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, doc, setDoc, onSnapshot } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBt8khl7RpfjyIecK736ELgdXGg4Rqe2UU",
            authDomain: "cost-saving-d103f.firebaseapp.com",
            projectId: "cost-saving-d103f",
            appId: "1:308687557118:web:62636951bb6a93b822b0af"
        };

        const appId = "cost-saving-d103f";
        const STORAGE_KEY = 'savings_hub_v3_data';
        
        let db, auth, user, efficiencyChart;
        let wsFleets = [], decomWs = [], apps = [], yearlyLogs = [];

        const BUNDLES = {
            "value": { name: "Value", m: 26, hb: 8, hr: 0.22 },
            "standard": { name: "Standard", m: 33, hb: 11, hr: 0.30 },
            "perf": { name: "Performance", m: 45, hb: 13, hr: 0.42 },
            "power": { name: "Power", m: 65, hb: 13, hr: 0.62 },
            "powerpro": { name: "PowerPro", m: 110, hb: 16, hr: 1.15 }
        };

        // EXPORT AS TEXT FUNCTION
        window.exportToText = () => {
            const dateStr = new Date().toLocaleDateString();
            const latestActual = [...yearlyLogs].sort((a,b) => b.year - a.year)[0]?.amount || 0;
            const liability = document.getElementById('sum-liability')?.innerText || "£0";
            const totalValue = document.getElementById('sum-total-value')?.innerText || "£0";

            let content = `CLOUD COST OPTIMIZATION REPORT - ${dateStr}\n`;
            content += `==========================================\n\n`;
            
            content += `EXECUTIVE SUMMARY\n`;
            content += `-----------------\n`;
            content += `Latest Actual Spend:  £${latestActual.toLocaleString()}\n`;
            content += `Projected Liability:  ${liability}\n`;
            content += `Total Realized Value: ${totalValue}\n\n`;

            content += `ACTIVE WORKSPACE FLEETS\n`;
            content += `-----------------------\n`;
            wsFleets.forEach(f => {
                const b = BUNDLES[f.bundle];
                const cost = (f.isAlwaysOn ? b.m : (b.hb + f.hours * b.hr)) * f.users * 12;
                content += `- ${f.name}: ${f.users} users (${b.name} bundle) | Mode: ${f.isAlwaysOn ? 'Always-On' : 'Auto-Stop'} | Ann: £${Math.round(cost).toLocaleString()}\n`;
            });
            content += `\n`;

            if (decomWs.length > 0) {
                content += `DECOMMISSIONED ASSETS (RETIRED)\n`;
                content += `-------------------------------\n`;
                decomWs.forEach(d => {
                    const b = BUNDLES[d.bundle];
                    const savings = (d.isAlwaysOn ? b.m : (b.hb + d.hours * b.hr)) * d.users * 12;
                    content += `- ${d.name}: £${Math.round(savings).toLocaleString()} realized annual saving\n`;
                });
                content += `\n`;
            }

            if (apps.length > 0) {
                content += `SOFTWARE TRACKER\n`;
                content += `----------------\n`;
                apps.forEach(a => {
                    content += `- ${a.name}: £${(a.price * a.users * 12).toLocaleString()} per annum (${a.isSaving ? 'SAVING' : 'LIABILITY'})\n`;
                });
            }

            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Cloud_Optimization_Report_${new Date().toISOString().slice(0,10)}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast("Report Exported as .txt");
        };

        const initApp = async () => {
            loadFromLocalStorage();
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                onAuthStateChanged(auth, (u) => {
                    user = u;
                    const statusEl = document.getElementById('auth-status');
                    if (u) {
                        if (statusEl) statusEl.innerText = "Connected ✅";
                        setupSharedListener();
                    }
                });
                await signInAnonymously(auth);
            } catch (e) { console.error(e); }
        };

        function setupSharedListener() {
            const ref = doc(db, 'artifacts', appId, 'public', 'data', 'configs', 'shared');
            onSnapshot(ref, (snap) => {
                if (snap.exists()) {
                    const data = snap.data();
                    wsFleets = data.wsFleets || wsFleets;
                    decomWs = data.decomWs || decomWs;
                    apps = data.apps || apps;
                    yearlyLogs = data.yearlyLogs || yearlyLogs;
                    refreshAll(true);
                }
            });
        }

        async function saveToCloud(isSilent = false) {
            if (!user) return;
            const ref = doc(db, 'artifacts', appId, 'public', 'data', 'configs', 'shared');
            try {
                await setDoc(ref, { wsFleets, decomWs, apps, yearlyLogs, updatedAt: new Date().toISOString() });
                if (!isSilent) showToast("Cloud Sync Complete");
            } catch (e) { showToast("Sync Failed", true); }
        }

        function refreshAll(skipSync = false) {
            renderWsFleets(); renderDecomWs(); renderAppList(); renderYearlyLogs();
            updateCalculationsAndUI();
            saveToLocalStorage();
            if (!skipSync && document.getElementById('auto-sync-toggle')?.checked) saveToCloud(true);
        }

        function updateCalculationsAndUI() {
            let wsTotal = 0, wsOpt = 0, wsUsers = 0;
            wsFleets.forEach(f => {
                const b = BUNDLES[f.bundle];
                const autoStopMonthly = b.hb + (f.hours * b.hr);
                const currMonthly = f.isAlwaysOn ? b.m : autoStopMonthly;
                const bestMonthly = Math.min(autoStopMonthly, b.m);
                wsTotal += (currMonthly * f.users * 12);
                wsOpt += Math.max(0, (currMonthly - bestMonthly) * f.users * 12);
                wsUsers += f.users;
            });

            let decomTotal = 0;
            decomWs.forEach(d => {
                const b = BUNDLES[d.bundle];
                const monthly = d.isAlwaysOn ? b.m : (b.hb + d.hours * b.hr);
                decomTotal += (monthly * d.users * 12);
            });

            let appsLiability = 0, appsSavings = 0;
            apps.forEach(a => {
                const total = a.price * a.users * 12;
                if (a.isSaving) appsSavings += total; else appsLiability += total;
            });

            const latestActual = [...yearlyLogs].sort((a,b) => b.year - a.year)[0]?.amount || 0;
            const realizedSavings = decomTotal + appsSavings;

            setInnerText('sum-actual-spend', `£${Math.round(latestActual).toLocaleString()}`);
            setInnerText('sum-liability', `£${Math.round(wsTotal + appsLiability).toLocaleString()}`);
            setInnerText('sum-total-value', `£${Math.round(realizedSavings + wsOpt).toLocaleString()}`);
            setInnerText('sum-breakdown-ws', `£${Math.round(wsTotal).toLocaleString()}`);
            setInnerText('sum-breakdown-ws-opt', `£${Math.round(wsOpt).toLocaleString()} Optimization Opportunity`);
            setInnerText('sum-breakdown-decom', `£${Math.round(decomTotal).toLocaleString()}`);
            setInnerText('sum-breakdown-sw', `£${Math.round(appsLiability - appsSavings).toLocaleString()}`);
            setInnerText('ws-total-users', wsUsers.toLocaleString());
            setInnerText('ws-total-annual', `£${Math.round(wsTotal).toLocaleString()}`);
            setInnerText('ws-total-opt', `£${Math.round(wsOpt).toLocaleString()}`);
            setInnerText('nav-cost-total', `£${Math.round(wsTotal + appsLiability).toLocaleString()} Active Spend`);
            setInnerText('comparison-projected', `£${Math.round(wsTotal).toLocaleString()}`);
            setInnerText('comparison-actual', `£${Math.round(latestActual).toLocaleString()}`);
            
            const variance = latestActual - wsTotal;
            const varEl = document.getElementById('comparison-variance');
            if (varEl) {
                varEl.innerText = `${variance >= 0 ? '+' : ''}£${Math.round(variance).toLocaleString()}`;
                varEl.className = `text-xl font-bold ${variance > 0 ? 'text-rose-500' : 'text-emerald-500'}`;
            }
            renderChart(wsTotal, wsOpt);
        }

        function setInnerText(id, text) { const el = document.getElementById(id); if(el) el.innerText = text; }

        function renderWsFleets() {
            const tbody = document.getElementById('ws-fleet-body');
            if(!tbody) return; tbody.innerHTML = '';
            wsFleets.forEach(f => {
                const b = BUNDLES[f.bundle];
                const row = document.createElement('tr');
                row.className = 'app-row border-b border-slate-50 hover:bg-slate-50/50 text-sm';
                row.innerHTML = `
                    <td class="px-6 py-4"><input type="text" value="${f.name}" class="bg-transparent w-full" data-field="name"></td>
                    <td class="px-6 py-4"><select class="w-full text-xs" data-field="bundle">${Object.keys(BUNDLES).map(k => `<option value="${k}" ${f.bundle === k ? 'selected' : ''}>${BUNDLES[k].name}</option>`).join('')}</select></td>
                    <td class="px-6 py-4 text-center"><input type="number" value="${f.users}" class="w-16 text-center" data-field="users"></td>
                    <td class="px-6 py-4 text-center"><input type="number" value="${f.hours}" class="w-16 text-center" data-field="hours"></td>
                    <td class="px-6 py-4 text-center"><label class="switch"><input type="checkbox" ${f.isAlwaysOn ? 'checked' : ''} data-field="isAlwaysOn"><span class="slider"></span></label></td>
                    <td class="px-6 py-4 font-bold text-emerald-600 text-right">£${Math.round((f.isAlwaysOn ? b.m : (b.hb + f.hours * b.hr)) * f.users * 12).toLocaleString()}</td>
                    <td class="px-6 py-4 text-right no-print"><button class="text-rose-400 font-bold" onclick="deleteWsFleet(${f.id})">×</button></td>
                `;
                row.querySelectorAll('input, select').forEach(el => el.addEventListener('change', e => {
                    const item = wsFleets.find(i => i.id === f.id);
                    const field = el.dataset.field;
                    item[field] = (field === 'isAlwaysOn') ? e.target.checked : (field === 'name' || field === 'bundle' ? e.target.value : parseFloat(e.target.value) || 0);
                    refreshAll();
                }));
                tbody.appendChild(row);
            });
        }

        function renderDecomWs() {
            const tbody = document.getElementById('decom-ws-body');
            if(!tbody) return; tbody.innerHTML = '';
            decomWs.forEach(d => {
                const b = BUNDLES[d.bundle];
                const row = document.createElement('tr');
                row.className = 'app-row border-b border-slate-50 hover:bg-slate-50/50 text-sm';
                row.innerHTML = `
                    <td class="px-6 py-4"><input type="text" value="${d.name}" class="bg-transparent w-full" data-field="name"></td>
                    <td class="px-6 py-4 text-center"><select data-field="bundle">${Object.keys(BUNDLES).map(k => `<option value="${k}" ${d.bundle === k ? 'selected' : ''}>${BUNDLES[k].name}</option>`).join('')}</select></td>
                    <td class="px-6 py-4 text-center"><input type="number" value="${d.users}" class="w-16 text-center" data-field="users"></td>
                    <td class="px-6 py-4 text-center"><input type="number" value="${d.hours}" class="w-16 text-center" data-field="hours"></td>
                    <td class="px-6 py-4 text-center"><label class="switch"><input type="checkbox" ${d.isAlwaysOn ? 'checked' : ''} data-field="isAlwaysOn"><span class="slider"></span></label></td>
                    <td class="px-6 py-4 font-bold text-emerald-600 text-right">£${Math.round((d.isAlwaysOn ? b.m : (b.hb + d.hours * b.hr)) * d.users * 12).toLocaleString()}</td>
                    <td class="px-6 py-4 text-right no-print"><button class="text-rose-400 font-bold" onclick="deleteDecom(${d.id})">×</button></td>
                `;
                row.querySelectorAll('input, select').forEach(el => el.addEventListener('change', e => {
                    const item = decomWs.find(i => i.id === d.id);
                    const field = el.dataset.field;
                    item[field] = (field === 'isAlwaysOn') ? e.target.checked : (field === 'name' || field === 'bundle' ? e.target.value : parseFloat(e.target.value) || 0);
                    refreshAll();
                }));
                tbody.appendChild(row);
            });
        }

        function renderYearlyLogs() {
            const tbody = document.getElementById('yearly-spend-body');
            if(!tbody) return; tbody.innerHTML = '';
            [...yearlyLogs].sort((a,b) => b.year - a.year).forEach(log => {
                const row = document.createElement('tr');
                row.className = 'border-b border-slate-50 text-sm';
                row.innerHTML = `
                    <td class="px-6 py-4"><input type="number" value="${log.year}" class="w-20" data-field="year"></td>
                    <td class="px-6 py-4"><input type="text" value="${log.notes || ''}" class="w-full text-slate-500" data-field="notes"></td>
                    <td class="px-6 py-4 text-right">£<input type="number" value="${log.amount}" class="w-32 text-right font-bold" data-field="amount"></td>
                    <td class="px-6 py-4 text-right no-print"><button class="text-rose-400 font-bold" onclick="deleteYearlyLog(${log.id})">×</button></td>
                `;
                row.querySelectorAll('input').forEach(el => el.addEventListener('change', e => {
                    const item = yearlyLogs.find(i => i.id === log.id);
                    const field = el.dataset.field;
                    item[field] = field === 'notes' ? e.target.value : parseFloat(e.target.value) || 0;
                    refreshAll();
                }));
                tbody.appendChild(row);
            });
        }

        function renderAppList() {
            const tbody = document.getElementById('app-list-body');
            if(!tbody) return; tbody.innerHTML = '';
            apps.forEach(a => {
                const row = document.createElement('tr');
                row.className = 'border-b border-slate-50 text-sm';
                row.innerHTML = `
                    <td class="px-6 py-4"><input type="text" value="${a.name}" class="w-full" data-field="name"></td>
                    <td class="px-6 py-4 text-center"><select data-field="type"><option value="liability" ${!a.isSaving ? 'selected' : ''}>Liability</option><option value="saving" ${a.isSaving ? 'selected' : ''}>Saving</option></select></td>
                    <td class="px-6 py-4 text-right">£<input type="number" value="${a.price}" class="w-24 text-right" data-field="price"></td>
                    <td class="px-6 py-4 text-right"><button onclick="deleteApp(${a.id})" class="text-rose-400 font-bold">×</button></td>
                `;
                row.querySelectorAll('input, select').forEach(el => el.addEventListener('change', (e) => {
                    const item = apps.find(x => x.id === a.id);
                    const field = el.dataset.field;
                    if (field === 'name') item.name = e.target.value;
                    if (field === 'price') item.price = parseFloat(e.target.value) || 0;
                    if (field === 'type') item.isSaving = (e.target.value === 'saving');
                    refreshAll();
                }));
                tbody.appendChild(row);
            });
        }

        function renderChart(total, opt) {
            const canvas = document.getElementById('efficiency-chart');
            const ctx = canvas?.getContext('2d');
            if(!ctx) return;
            if (efficiencyChart) efficiencyChart.destroy();
            efficiencyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Current Fleet', 'Optimized'],
                    datasets: [{ label: 'Annual Cost', data: [total, total - opt], backgroundColor: ['#1e293b', '#10b981'], borderRadius: 12, barThickness: 40 }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { callback: v => '£' + v.toLocaleString(), font: { size: 10 } }, grid: { display: false } }, x: { grid: { display: false } } } }
            });
        }

        function saveToLocalStorage() { localStorage.setItem(STORAGE_KEY, JSON.stringify({ wsFleets, decomWs, apps, yearlyLogs })); }
        function loadFromLocalStorage() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) { try { const data = JSON.parse(saved); wsFleets = data.wsFleets || []; decomWs = data.decomWs || []; apps = data.apps || []; yearlyLogs = data.yearlyLogs || []; refreshAll(true); } catch (e) {} }
        }
        function showToast(msg, isError = false) {
            const toast = document.getElementById('status-toast');
            const messageEl = document.getElementById('toast-message');
            if (messageEl) messageEl.innerText = msg;
            toast.className = `fixed bottom-8 right-8 text-white px-6 py-3 rounded-2xl shadow-2xl flex items-center gap-3 transition-all duration-300 ${isError ? 'bg-rose-600' : 'bg-slate-900'} show`;
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        window.showPage = id => {
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            document.getElementById('nav-' + id)?.classList.add('active');
            document.querySelectorAll('.page-content').forEach(p => p.classList.remove('active'));
            document.getElementById('page-' + id)?.classList.add('active');
        };

        window.addWsFleet = () => { wsFleets.push({ id: Date.now(), name: 'New Fleet', bundle: 'standard', users: 5, hours: 40, isAlwaysOn: false }); refreshAll(); };
        window.deleteWsFleet = id => { wsFleets = wsFleets.filter(f => f.id !== id); refreshAll(); };
        window.addDecomWs = () => { decomWs.push({ id: Date.now(), name: 'New Retired Asset', bundle: 'standard', users: 1, hours: 160, isAlwaysOn: true }); refreshAll(); };
        window.deleteDecom = id => { decomWs = decomWs.filter(d => d.id !== id); refreshAll(); };
        window.addNewApp = () => { apps.push({ id: Date.now(), name: 'New App', price: 100, users: 1, isSaving: false }); refreshAll(); };
        window.deleteApp = id => { apps = apps.filter(a => a.id !== id); refreshAll(); };
        window.addYearlyLog = () => { yearlyLogs.push({ id: Date.now(), year: new Date().getFullYear(), amount: 0, notes: '' }); refreshAll(); };
        window.deleteYearlyLog = id => { yearlyLogs = yearlyLogs.filter(l => l.id !== id); refreshAll(); };

        document.getElementById('btn-push')?.addEventListener('click', () => saveToCloud());
        document.getElementById('btn-refresh')?.addEventListener('click', () => setupSharedListener());

        initApp();
    </script>
</body>
</html>